// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String   // bcrypt hashed
  role      String   @default("USER") // USER or ADMIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tournaments Tournament[] // Tournaments created by admin
  teamMemberships TeamMember[] // Teams the user is part of

  @@map("users")
}

model Tournament {
  id          String   @id @default(cuid())
  name        String
  description String?
  date        DateTime
  status      String   @default("UPCOMING") // UPCOMING, IN_PROGRESS, COMPLETED, CANCELLED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  teams       Team[]
  matches     Match[]

  @@map("tournaments")
}

model Team {
  id           String   @id @default(cuid())
  name         String
  player1Name  String?  // Optional: for admin-created teams with guest players
  player2Name  String?  // Optional: for admin-created teams with guest players
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  members      TeamMember[]  // For user-registered teams
  homeMatches  Match[]    @relation("HomeTeam")
  awayMatches  Match[]    @relation("AwayTeam")

  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_members")
}

model Match {
  id           String   @id @default(cuid())
  matchNumber  Int      // Chronological order (1, 2, 3, ...)
  homeScore    Int?     // Nullable until match is completed
  awayScore    Int?     // Nullable until match is completed
  status       String   @default("UPCOMING") // UPCOMING, IN_PROGRESS, COMPLETED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  homeTeamId   String
  homeTeam     Team       @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)

  awayTeamId   String
  awayTeam     Team       @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, matchNumber])
  @@map("matches")
}
